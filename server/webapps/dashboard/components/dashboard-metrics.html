<!-- Downloads and Uploads -->
<div class="row">
    <div class="col-lg-6">
        <div class="ibox float-e-margins" id="time-series-downloads">
            <div class="ibox-content">
                <div>
                    <div class="sk-spinner sk-spinner-three-bounce">
                        <div class="sk-bounce1"></div>
                        <div class="sk-bounce2"></div>
                        <div class="sk-bounce3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="ibox float-e-margins" id="time-series-uploads">
            <div class="ibox-content">
                <div>
                    <div class="sk-spinner sk-spinner-three-bounce">
                        <div class="sk-bounce1"></div>
                        <div class="sk-bounce2"></div>
                        <div class="sk-bounce3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Avg sessions -->
<div class="row">
    <div class="col-lg-6">
        <div class="ibox float-e-margins" id="time-series-avgdownloads">
            <div class="ibox-content">
                <div>
                    <div class="sk-spinner sk-spinner-three-bounce">
                        <div class="sk-bounce1"></div>
                        <div class="sk-bounce2"></div>
                        <div class="sk-bounce3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="ibox float-e-margins" id="time-series-avgsessiontime">
            <div class="ibox-content">
                <div>
                    <div class="sk-spinner sk-spinner-three-bounce">
                        <div class="sk-bounce1"></div>
                        <div class="sk-bounce2"></div>
                        <div class="sk-bounce3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="ibox float-e-margins" id="metric-downloads">
            <div class="ibox-title">
                <span class="label label-{{{style}}} pull-right">Today</span>
                <h5></h5>
            </div>
            <div class="ibox-content">
                <div class="sk-spinner sk-spinner-three-bounce">
                    <div class="sk-bounce1"></div>
                    <div class="sk-bounce2"></div>
                    <div class="sk-bounce3"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="ibox float-e-margins" id="metric-uploads">
            <div class="ibox-title">
                <span class="label label-{{{style}}} pull-right">Today</span>
                <h5></h5>
            </div>
            <div class="ibox-content">
                <div class="sk-spinner sk-spinner-three-bounce">
                    <div class="sk-bounce1"></div>
                    <div class="sk-bounce2"></div>
                    <div class="sk-bounce3"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="ibox float-e-margins" id="metric-totalusers">
            <div class="ibox-title">
                <span class="label label-{{{style}}} pull-right">Today</span>
                <h5></h5>
            </div>
            <div class="ibox-content">
                <div class="sk-spinner sk-spinner-three-bounce">
                    <div class="sk-bounce1"></div>
                    <div class="sk-bounce2"></div>
                    <div class="sk-bounce3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="ibox float-e-margins" id="metric-avgdatausageperuser">
            <div class="ibox-title">
                <span class="label label-{{{style}}} pull-right">Today</span>
                <h5></h5>
            </div>
            <div class="ibox-content">
                <div class="sk-spinner sk-spinner-three-bounce">
                    <div class="sk-bounce1"></div>
                    <div class="sk-bounce2"></div>
                    <div class="sk-bounce3"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="ibox float-e-margins" id="metric-avgsessiontime">
            <div class="ibox-title">
                <span class="label label-{{{style}}} pull-right">Today</span>
                <h5></h5>
            </div>
            <div class="ibox-content">
                <div class="sk-spinner sk-spinner-three-bounce">
                    <div class="sk-bounce1"></div>
                    <div class="sk-bounce2"></div>
                    <div class="sk-bounce3"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="ibox float-e-margins" id="metric-totalsessioncount">
            <div class="ibox-title">
                <span class="label label-{{{style}}} pull-right">Today</span>
                <h5></h5>
            </div>
            <div class="ibox-content">
                <div class="sk-spinner sk-spinner-three-bounce">
                    <div class="sk-bounce1"></div>
                    <div class="sk-bounce2"></div>
                    <div class="sk-bounce3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" style="margin-top: 40px;">

    <div class="col-lg-4">
        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins" id="metric-usercountover1MB">
                    <div class="ibox-title">
                        <span class="label label-{{{style}}} pull-right">Today</span>
                        <h5></h5>
                    </div>
                    <div class="ibox-content">
                        <div class="sk-spinner sk-spinner-three-bounce">
                            <div class="sk-bounce1"></div>
                            <div class="sk-bounce2"></div>
                            <div class="sk-bounce3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins" id="metric-returningusers">
                    <div class="ibox-title">
                        <span class="label label-{{{style}}} pull-right">Today</span>
                        <h5></h5>
                    </div>
                    <div class="ibox-content">
                        <div class="sk-spinner sk-spinner-three-bounce">
                            <div class="sk-bounce1"></div>
                            <div class="sk-bounce2"></div>
                            <div class="sk-bounce3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="col-lg-4">
        <div class="ibox float-e-margins" id="metric-usersbyos">
            <div class="ibox-title">
                <span class="label label-{{{style}}} pull-right">Today</span>
                <h5></h5>
            </div>
            <div class="ibox-content">
                <div class="sk-spinner sk-spinner-three-bounce">
                    <div class="sk-bounce1"></div>
                    <div class="sk-bounce2"></div>
                    <div class="sk-bounce3"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="ibox float-e-margins">
            <div class="ibox float-e-margins" id="metric-usersbydevicetype">
                <div class="ibox-title">
                    <span class="label label-{{{style}}} pull-right">Today</span>
                    <h5></h5>
                </div>
                <div class="ibox-content">
                    <div class="sk-spinner sk-spinner-three-bounce">
                        <div class="sk-bounce1"></div>
                        <div class="sk-bounce2"></div>
                        <div class="sk-bounce3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(
            function () {
                var payload = {
                    from: from_,
                    to: to_,
                    groupnames: window.datagroups,
                    tenantid: parseInt(Cookies.get("tenantid"))
                }
                window.payload = payload
                var totaldownloads = 0, totaluploads = 0, uniqueuserscount = 0

                var renderTotalDownloads = $.post('/wifi/usage/downloads', JSON.stringify(payload), function (data, status) {
                    totaldownloads = data
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Total Downloads',
                            value: numeral(data).format('0.00b'),
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-downloads').html(rendered)
                    })
                });

                var renderTotalUploads = $.post('/wifi/usage/uploads', JSON.stringify(payload), function (data, status) {
                    totaluploads = data
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Total Uploads',
                            value: numeral(data).format('0.00b'),
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-uploads').html(rendered)
                    })
                });

                var renderTotalUserCount = $.post('/wifi/users/count', JSON.stringify(payload), function (data, status) {
                    uniqueuserscount = (data === 0 ? 1 : data);
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Total Users',
                            value: data,
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-totalusers').html(rendered)
                    })
                });

                $.post('/wifi/sessions/avg', JSON.stringify(payload), function (data, status) {
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Avg User session time',
                            value: numeral(data).format('00:00:00'),
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-avgsessiontime').html(rendered)
                    })
                });

                $.post('/wifi/sessions/count', JSON.stringify(payload), function (data, status) {
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Total Sessions',
                            value: data,
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-totalsessioncount').html(rendered)
                    })
                });

                $.post('/wifi/users/countbydownlods/1000000', JSON.stringify(payload), function (data, status) {
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Unique Users (>1MB)',
                            value: data,
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-usercountover1MB').html(rendered)
                    })
                });

                $.when(renderTotalDownloads, renderTotalUploads, renderTotalUserCount).done(function () {
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Avg Data Usage per User',
                            value: numeral((totaldownloads + totaluploads) / uniqueuserscount).format('0.00b'),
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-avgdatausageperuser').html(rendered)
                    })
                });

                $.post('/wifi/users/returncount', JSON.stringify(payload), function (data, status) {
                    $.get('components/metric-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            caption: 'Returning Users',
                            value: data,
                            titlecolor: '#12A6A8'
                        });
                        $('#metric-returningusers').html(rendered)
                    })
                });

                $.post('/wifi/devices/osstats', JSON.stringify(payload), function (data, status) {
                    $.get('components/metric-piechart-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            id: 0,
                            caption: 'Users by Browser',
                            style: 'success',
                            data: JSON.stringify(getPieChartData(data)),
                            titlecolor: '#2F4050'
                        });
                        $('#metric-usersbyos').html(rendered)
                    })
                });

                $.post('/wifi/devices/devicestats', JSON.stringify(payload), function (data, status) {
                    $.get('components/metric-piechart-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            id: 1,
                            caption: 'device Stats',
                            style: 'success',
                            data: JSON.stringify(getPieChartData(data)),
                            titlecolor: '#2F4050'
                        })
                        $('#metric-usersbydevicetype').html(rendered)
                    })
                });

                downloadsTimeSeriesData = []

                $.post('/wifi/usage/dailytotaldownloads', JSON.stringify(payload), function (data, status) {
                    var locationDist = {type: 'spline', name: window.appName, data: convertToHighChartSeries(data)}
                    downloadsTimeSeriesData.push(locationDist);
                    renderTimeSeries('time-series-downloads', 'Total Daily Downloads Distribution', "Downloads (MB)", downloadsTimeSeriesData);
                });

                uploadsTimeSeriesData = []
                $.post('/wifi/usage/dailytotaluploads', JSON.stringify(payload), function (data, status) {
                    var locationDist = {type: 'spline', name: window.appName, data: convertToHighChartSeries(data)}
                    uploadsTimeSeriesData.push(locationDist);
                    renderTimeSeries('time-series-uploads', 'Total Daily Uploads Distribution', "Uploads (MB)", uploadsTimeSeriesData);
                });

                avgDownloadsTimeSeriesData = []
                $.post('/wifi/usage/dailyavguserdownloads', JSON.stringify(payload), function (data, status) {
                    var locationDist = {type: 'spline', name: window.appName, data: convertToHighChartSeries(data)}
                    avgDownloadsTimeSeriesData.push(locationDist);
                    renderTimeSeries('time-series-avgdownloads', 'Average Daily User Downloads Distribution', "Downloads (MB)", avgDownloadsTimeSeriesData);
                });

                avgUserSessionTimeSeriesData = []
                $.post('/wifi/usage/dailyavgusersessiontime', JSON.stringify(payload), function (data, status) {
                    var locationDist = {type: 'spline', name: window.appName, data: convertToHighChartSeries(data)}
                    avgUserSessionTimeSeriesData.push(locationDist);
                    renderTimeSeries('time-series-avgsessiontime', 'Average Daily User Session Time Distribution', "Time", avgUserSessionTimeSeriesData);
                });

                function renderTimeSeries(elementId, caption, yAxis, data) {
                    $.get('components/metric-timeserieschart-base.html', function (template) {
                        var rendered = Mustache.render(template, {
                            id: elementId,
                            caption: caption,
                            yAxis: yAxis,
                            style: 'success',
                            data: JSON.stringify(data)
                        });
                        $('#' + elementId).html(rendered)
                    })
                }

                $('#time-series-downloads').on('click', '#time-series-downloads-compare-btn', function (e) {
                    downloadsTimeSeriesData = []
                    $.each(window.originaldatagroups, function (i, val) {
                        var payload2 = payload
                        payload2.groupnames = [val]
                        $.post('/wifi/usage/dailytotaldownloads', JSON.stringify(payload2), function (data, status) {
                            var locationDist = {type: 'spline', name: val, data: convertToHighChartSeries(data)}
                            downloadsTimeSeriesData.push(locationDist);
                        });
                    });
                    renderTimeSeries('time-series-downloads', 'Total Daily Downloads Distribution', "Downloads (MB)", downloadsTimeSeriesData);
                });

                $('#time-series-uploads').on('click', '#time-series-uploads-compare-btn', function (e) {
                    downloadsTimeSeriesData = []
                    $.each(window.originaldatagroups, function (i, val) {
                        var payload2 = payload
                        payload2.groupnames = [val]
                        $.post('/wifi/usage/dailytotaluploads', JSON.stringify(payload2), function (data, status) {
                            var locationDist = {type: 'spline', name: val, data: convertToHighChartSeries(data)}
                            downloadsTimeSeriesData.push(locationDist);
                        });
                    });
                    renderTimeSeries('time-series-uploads', 'Total Daily Uploads Distribution', "Downloads (MB)", downloadsTimeSeriesData);
                });

                $('#time-series-avgdownloads').on('click', '#time-series-avgdownloads-compare-btn', function (e) {
                    avgDownloadsTimeSeriesData = []
                    $.each(window.originaldatagroups, function (i, val) {
                        var payload2 = payload
                        payload2.groupnames = [val]
                        $.post('/wifi/usage/dailyavguserdownloads', JSON.stringify(payload2), function (data, status) {
                            var locationDist = {type: 'spline', name: val, data: convertToHighChartSeries(data)}
                            avgDownloadsTimeSeriesData.push(locationDist);
                        });
                    });
                    renderTimeSeries('time-series-avgdownloads', 'Average Daily User Downloads Distribution', "Downloads (MB)", avgDownloadsTimeSeriesData);
                });

                $('#time-series-avgsessiontime').on('click', '#time-series-avgsessiontime-compare-btn', function (e) {
                    avgUserSessionTimeSeriesData = []
                    $.each(window.originaldatagroups, function (i, val) {
                        var payload2 = payload
                        payload2.groupnames = [val]
                        $.post('/wifi/usage/dailyavgusersessiontime', JSON.stringify(payload2), function (data, status) {
                            var locationDist = {type: 'spline', name: val, data: convertToHighChartSeries(data)}
                            avgUserSessionTimeSeriesData.push(locationDist);
                        });
                    });
                    renderTimeSeries('time-series-avgsessiontime', 'Average Daily User Session Time Distribution', "Time", avgUserSessionTimeSeriesData);
                });

                WinMove();
                function convertToHighChartSeries(arr) {
                    return data = $.map(arr, function (val, i) {
                        return [[moment(val.name, 'YYYY-M-D H:m:s').valueOf(), val.value / 1000000]];
                    });
                    return data;
                }

                function getChartData(data) {
                    var chartData = $.map(data, function (obj, i) {
                        return [[obj.name, obj.value]];
                    });
                    return chartData;
                }

                function getPieChartData(data) {
                    var pieChartData = $.map(data, function (obj, i) {
                        return [{"name": obj.name, "y": obj.value}];
                    });
                    return pieChartData;
                }

                // Dragable panels
                function WinMove() {
                    var element = "[class*=col]";
                    var handle = ".ibox-title";
                    var connect = "[class*=col]";
                    $(element).sortable(
                            {
                                handle: handle,
                                connectWith: connect,
                                tolerance: 'pointer',
                                forcePlaceholderSize: true,
                                opacity: 0.8
                            })
                            .disableSelection();
                }
            }
    );

</script>