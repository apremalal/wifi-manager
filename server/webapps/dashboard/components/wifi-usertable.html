<div class="col-lg-12">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>Wi-Fi user table</h5>
            <div class="ibox-tools">
                <a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                </a>
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="fa fa-wrench"></i>
                </a>
                <ul class="dropdown-menu dropdown-user">
                    <li><a href="#" id="add-user-opt">Add User</a></li>
                </ul>
                <a class="close-link">
                    <i class="fa fa-times"></i>
                </a>
            </div>
        </div>
        <div class="ibox-content">

            <table class="table table-striped table-bordered table-hover dataTables-user"  >
                <thead>
                <tr>
                    <th>Username</th>
                    <th>ACL</th>
                    <th>Location</th>
                    <th>Visit count</th>
                    <th>Acct start Time</th>
                    <th>Acct Stop Time</th>
                    <th>Acct Last Updated Time</th>
                    <th>Settings</th>
                </tr>
                <tr>
                    <th></th>
                    <th>ACL</th>
                    <th>Location</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<div class="modal inmodal" id="adduser-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <i class="fa fa-user-md modal-icon"></i>
                <h4 class="modal-title">Add WiFi User</h4>
                <small class="font-bold">Add wifi users and configure Access Control</small>
            </div>
            <div class="modal-body">
                <hr>
                <form role="form" id="adduser-form">
                    <div class="form-group">
                        <label for="inputEditUsername">Username</label>
                        <input type="text" class="form-control" id="inputUsername" name="editusername" placeholder="Username" required>
                    </div>
                    <div class="form-group">
                        <label for="inputEditPassword">Password</label>
                        <input type="text" class="form-control" id="inputtPassword" name="editpassword" placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <label for="radioIsBlackListed">Access Control</label>
                    </div>
                    <div class="checkbox">
                        <label class="radio inline control-label"><input type="radio"  id="radioIsWhiteListed" class="radio" name="role-select" value="whitelisted">White Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio"  id="radioIsBlackListed" class="radio" name="role-select" value="blacklisted">Black Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio"  id="radioIsNormalUser" class="radio" name="role-select" value="normaluser">Normal User</label><br/>
                    </div>
                    <div class="checkbox">
                        <hr/>
                        <label>
                            <input type="checkbox" id="chkEditIsActive"> Start Accounting
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-add-user">Add User</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" style="text-align: center">Delete User</h4>
            </div>
            <div class="modal-body">
                <p id="message"><strong>Are you sure you want to delete the user?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" id="delete-user">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal inmodal" id="edituser-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <i class="fa fa-user-md modal-icon"></i>
                <h4 class="modal-title">Edit WiFi User</h4>
                <small class="font-bold">Edit wifi users' options</small>
            </div>
            <div class="modal-body">
                <hr>
                <form role="form" id="edituser-form">
                    <div class="form-group">
                        <label for="inputEditUsername">Username</label>
                        <input type="text" class="form-control" id="inputEditUsername" name="editusername" placeholder="Username" required readonly="readonly">
                    </div>
                    <div class="form-group">
                        <label for="inputEditPassword">Password</label>
                        <input type="text" class="form-control" id="inputEditPassword" name="editpassword" placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <label for="radioEditIsBlackListed">Access Control</label>
                    </div>
                    <div class="checkbox">
                        <label class="radio inline control-label"><input type="radio"  id="radioEditIsWhiteListed" class="radio" name="role-select" value="whitelisted">White Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio"  id="radioEditIsBlackListed" class="radio" name="role-select" value="blacklisted">Black Listed</label><br/>
                        <label class="radio inline control-label"><input type="radio"  id="radioEditIsNormalUser" class="radio" name="role-select" value="normaluser">Normal User</label><br/>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn-edit-user">Update User</button>
            </div>
        </div>
    </div>
</div>

<script src="js/plugins/validate/jquery.validate.min.js"></script>
<script>
    var userTable = $('.dataTables-user').DataTable({
            responsive : true,
            orderCellsTop: true,
            data: {{{data}}},
            columns: [
                { "data": "username" , "width": "15%"},
                { "data": "acl" , "width": "7%"},
                { "data": "location" , "width": "10%"},
                { "data": "visits" , "width": "5%"},
                { "data": "acctstarttime" , "width": "10%"},
                { "data": "acctstoptime" , "width": "10%"},
                { "data": "acctlastupdatedtime" , "width": "10%"},
                {"data": null,"defaultContent": "<div class='btn-group'><button class='btn btn-white btn-xs dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'><i class='fa fa-gear'></i></button><ul class='dropdown-menu'><li><a href='#' id='setting-edit-user'>Edit</a></li><li><a href='#' id='setting-change-password'>Change Password</a></li><li><a href='#' id='setting-delete-user'>Delete</a></li></ul></div>", "width" : "1%", "className" :'center', "sortable" : false},
            ],
             dom: 'T<"clear">lfrtip',
             tableTools: {
                "sSwfPath": "js/plugins/dataTables/swf/copy_csv_xls_pdf.swf"
            }
        });

    $('.dataTables-user').dataTable().columnFilter({
        sPlaceHolder: "head:before",
        aoColumns: [
            null,
            { type: "select", values: [ 'whitelisted', 'blacklisted', 'normaluser'] },
            { type: "select", values: [ '4.0.0', '3.0.0', '2.0.0', '1.0.0'] },
            {"bSortable": false },
            {"bSortable": false },
            {"bSortable": false },
            {"bSortable": false },
            null
        ]
    });

    $('.dataTables-user tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            userTable.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
    } );

    var selectedUser,rowToDelete;
    $('#delete-user').on("click", function(event){
        $.ajax({
            url: '/wifi/users/'+ selectedUser.username,
            type: 'DELETE',
            success: function(result) {
                $('#confirm-delete-modal').modal('hide')
                rawTodelete.remove();
            },
            error: function(e){
                console.log(e)
            }
        });
        return false;
    });

    $('.dataTables-user tbody').on( 'click', '#setting-delete-user', function () {
        selectedUser = userTable.row( $(this).parents('tr') ).data();
        rawTodelete =$(this).closest('tr');
        $('#confirm-delete-modal').modal()
        $('#message').html('<i class="fa fa-warning fa-3x" style="vertical-align: middle;margin-right: 10%"></i>Are you sure you want to delete the user? <strong>' + selectedUser.username  +'</strong>' );
    });

    $('.dataTables-user tbody').on('click', '#setting-edit-user', function () {
        selectedUser = userTable.row( $(this).parents('tr') ).data();
        //editUserFromValidator.resetForm();
        $('#edituser-modal').modal();
        $("#inputEditUsername").val(selectedUser.username);
        $("#inputEditEmail").val(selectedUser.email);
        if(selectedUser.whitelisted == 'active'){
            $("#chkEditIsWhiteListed").prop('checked',true);
        }else{
            $("#chkEditIsWhiteListed").prop('checked',false);
        }
    });

    $('#btn-edit-user').on("click", function(event){
        if($("#edituser-form").valid()){
            var newUserStatus = 'pending';
            if($('#chkEditIsActive').is(":checked")){
                newUserStatus = 'active';
            }
            var payload = {
                username : selectedUser.username,
                acl : $('.radio:checked').val()
            }

            $.ajax({
                url: '/wifi/users',
                type: 'PUT',
                contentType: "application/json",
                data : JSON.stringify(payload),
                success: function(result) {
                    $('#edituser-modal').modal('hide');
                },
                error: function(e){
                    console.log(e)
                }
            });
        }
        return false;
    });

    var adduserFromValidator =  $("#adduser-form").validate({
        rules: {
            password: {
                required: true,
                minlength: 5
            },
            username : {
                required: true,
                minlength: 3
            }
        }
    });

    $('body').on( 'click', '#add-user-opt', function () {
        $('#adduser-form').trigger('reset');
        adduserFromValidator.resetForm();
        $('#adduser-modal').modal()
    });

    $('#btn-add-user').on("click", function(event){
        if($("#adduser-form").valid()){
            var newUserStatus = 'pending';
            if($('#chkIsActive').is(":checked")){
                newUserStatus = 'active';
            }
            var payload = {
                tenantid : parseInt(Cookies.get('tenantId')),
                username : $('#inputUsername').val(),
                password : $('#inputPassword').val(),
                email : $('#inputEmail').val(),
                roles : [$('.radio:checked').val()],
                status : newUserStatus
            }
            $.post('/wifi/users',JSON.stringify(payload), function(result) {
                $('#adduser-modal').modal('hide');
            });
        }
        return false;
    });
 </script>